#!/usr/bin/env python3
"""
Complete System Installer for Real-time STT Polish
Kompletny installer systemu Real-time STT Polski

Autor: AI Assistant
Data: 2025-01-18
"""

import subprocess
import sys
import os
import platform
import importlib.util
from pathlib import Path

def print_banner():
    """Wy≈õwietl banner instalatora"""
    print("üöÄ Real-time Speech-to-Text Polish - Kompletny Installer")
    print("=" * 60)
    print("üé§ Automatyczna instalacja wszystkich komponent√≥w systemu")
    print("üîß Konfiguracja ≈õrodowiska dla optymalnej wydajno≈õci")
    print()

def check_python_version():
    """Sprawd≈∫ wersjƒô Python"""
    print("üêç Sprawdzanie wersji Python...")
    
    version = sys.version_info
    print(f"   Python {version.major}.{version.minor}.{version.micro}")
    
    if version < (3, 8):
        print("‚ùå Wymagany Python 3.8 lub nowszy!")
        print("üí° Pobierz najnowszƒÖ wersjƒô z https://python.org")
        return False
    elif version < (3, 9):
        print("‚ö†Ô∏è Python 3.9+ zalecany dla lepszej wydajno≈õci")
    
    print("‚úÖ Wersja Python OK")
    return True

def install_package(package, description="", quiet=True):
    """Zainstaluj pakiet przez pip"""
    print(f"üì¶ Instalowanie {package}...")
    if description:
        print(f"   {description}")
    
    try:
        cmd = [sys.executable, "-m", "pip", "install", package, "--upgrade"]
        if quiet:
            cmd.append("--quiet")
        
        subprocess.check_call(cmd)
        print(f"‚úÖ {package} zainstalowany pomy≈õlnie")
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå B≈ÇƒÖd instalacji {package}: {e}")
        return False

def install_basic_dependencies():
    """Zainstaluj podstawowe dependencies"""
    print("\nüì¶ Instalacja podstawowych bibliotek...")
    
    basic_packages = [
        ("numpy>=1.24.0", "Numerical computing"),
        ("sounddevice>=0.4.6", "Audio input/output"),
        ("scipy>=1.10.0", "Scientific computing"),
        ("colorama>=0.4.6", "Colored terminal output"),
        ("tqdm>=4.65.0", "Progress bars"),
        ("psutil>=5.9.0", "System monitoring"),
        ("webrtcvad>=2.0.10", "Voice Activity Detection"),
        ("pyaudio>=0.2.11", "Audio processing"),
        ("pydub>=0.25.1", "Audio manipulation")
    ]
    
    results = []
    for package, description in basic_packages:
        result = install_package(package, description)
        results.append((package.split(">=")[0], result))
    
    successful = sum(1 for _, success in results if success)
    print(f"\nüìä Podstawowe pakiety: {successful}/{len(results)} zainstalowane")
    
    return successful >= len(results) * 0.8  # 80% success rate

def install_pytorch():
    """Zainstaluj PyTorch z odpowiedniƒÖ konfiguracjƒÖ"""
    print("\nüî• Instalacja PyTorch...")
    
    # Sprawd≈∫ czy ju≈º zainstalowany
    try:
        import torch
        print(f"‚úÖ PyTorch ju≈º zainstalowany: {torch.__version__}")
        if torch.cuda.is_available():
            print(f"üöÄ CUDA dostƒôpne: {torch.cuda.get_device_name(0)}")
        return True
    except ImportError:
        pass
    
    # Okre≈õl platformƒô i zainstaluj odpowiedniƒÖ wersjƒô
    system = platform.system().lower()
    
    if system == "windows":
        print("ü™ü Wykryto Windows - sprawdzanie GPU...")
        try:
            result = subprocess.run(["nvidia-smi"], capture_output=True)
            if result.returncode == 0:
                print("üöÄ NVIDIA GPU wykryte - instalujƒô CUDA version")
                torch_cmd = "torch torchaudio --index-url https://download.pytorch.org/whl/cu118"
            else:
                print("üíª Brak NVIDIA GPU - instalujƒô CPU version")
                torch_cmd = "torch torchaudio --index-url https://download.pytorch.org/whl/cpu"
        except:
            print("üíª Nie mo≈ºna wykryƒá GPU - instalujƒô CPU version")
            torch_cmd = "torch torchaudio"
    else:
        print(f"üêß Wykryto {system} - instalujƒô uniwersalnƒÖ wersjƒô")
        torch_cmd = "torch torchaudio"
    
    return install_package(torch_cmd, "Deep learning framework")

def install_whisper():
    """Zainstaluj OpenAI Whisper"""
    print("\nüé§ Instalacja OpenAI Whisper...")
    
    try:
        import whisper
        print(f"‚úÖ Whisper ju≈º zainstalowany")
        return True
    except ImportError:
        pass
    
    return install_package("openai-whisper>=20231117", "OpenAI Speech Recognition")

def install_optional_packages():
    """Zainstaluj opcjonalne pakiety"""
    print("\nüîß Instalacja opcjonalnych pakiet√≥w...")
    
    optional_packages = [
        ("python-docx>=0.8.11", "Microsoft Word export"),
        ("matplotlib>=3.5.0", "Plotting and visualization"),
        ("librosa>=0.9.0", "Advanced audio processing"),
        ("pytest>=7.0.0", "Testing framework"),
        ("black>=23.0.0", "Code formatting"),
        ("flake8>=6.0.0", "Code linting")
    ]
    
    results = []
    for package, description in optional_packages:
        result = install_package(package, description)
        results.append((package.split(">=")[0], result))
    
    successful = sum(1 for _, success in results if success)
    print(f"\nüìä Opcjonalne pakiety: {successful}/{len(results)} zainstalowane")
    
    return True  # Optional packages nie blokujƒÖ instalacji

def test_installation():
    """Przetestuj instalacjƒô"""
    print("\nüß™ Testowanie instalacji...")
    
    # Test podstawowych import√≥w
    tests = [
        ("numpy", "NumPy"),
        ("sounddevice", "SoundDevice"),
        ("scipy", "SciPy"),
        ("colorama", "Colorama"),
        ("psutil", "Psutil"),
        ("torch", "PyTorch"),
        ("whisper", "OpenAI Whisper")
    ]
    
    results = []
    for module, name in tests:
        try:
            __import__(module)
            print(f"‚úÖ {name} - OK")
            results.append(True)
        except ImportError:
            print(f"‚ö†Ô∏è {name} - Not available")
            results.append(False)
    
    # Test naszych modu≈Ç√≥w
    print("\nüîß Testowanie modu≈Ç√≥w systemu...")
    
    # Dodaj src do ≈õcie≈ºki
    sys.path.insert(0, str(Path(__file__).parent / "src"))
    
    our_modules = [
        ("audio_capture", "AudioCapture"),
        ("voice_activity_detector", "Voice Activity Detection"),
        ("stt_engine", "STT Engine"),
        ("realtime_pipeline", "RealtimePipeline"),
        ("performance_optimizer", "Performance Optimizer"),
        ("export_manager", "Export Manager"),
        ("gui_application", "GUI Application")
    ]
    
    for module, name in our_modules:
        try:
            __import__(module)
            print(f"‚úÖ {name} - OK")
            results.append(True)
        except ImportError as e:
            print(f"‚ùå {name} - Error: {e}")
            results.append(False)
    
    success_rate = sum(results) / len(results)
    print(f"\nüìä Sukces test√≥w: {success_rate:.1%}")
    
    return success_rate >= 0.8

def download_whisper_model():
    """Pobierz domy≈õlny model Whisper"""
    print("\nüì• Pobieranie modelu Whisper...")
    
    try:
        import whisper
        
        print("üì¶ Pobieranie modelu 'base' (mo≈ºe potrwaƒá kilka minut)...")
        model = whisper.load_model("base")
        print("‚úÖ Model 'base' pobrany pomy≈õlnie")
        
        # Test modelu
        print("üß™ Test modelu...")
        import numpy as np
        
        # Test z ciszƒÖ
        audio = np.zeros(16000, dtype=np.float32)
        result = model.transcribe(audio, language="pl")
        print(f"‚úÖ Test modelu zako≈Ñczony: '{result['text']}'")
        
        return True
        
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd pobierania modelu: {e}")
        return False

def create_desktop_shortcuts():
    """Stw√≥rz skr√≥ty na pulpicie"""
    print("\nüñ•Ô∏è Tworzenie skr√≥t√≥w...")
    
    try:
        desktop_path = Path.home() / "Desktop"
        if not desktop_path.exists():
            desktop_path = Path.home() / "Pulpit"  # Polish Windows
        
        if desktop_path.exists():
            # Skr√≥t do GUI
            gui_script = f"""@echo off
cd /d "{Path(__file__).parent}"
python gui_launcher.py
pause"""
            
            gui_shortcut = desktop_path / "Real-time STT GUI.bat"
            with open(gui_shortcut, 'w', encoding='utf-8') as f:
                f.write(gui_script)
            
            # Skr√≥t do CLI
            cli_script = f"""@echo off
cd /d "{Path(__file__).parent}"
python main.py --mode demo
pause"""
            
            cli_shortcut = desktop_path / "Real-time STT Demo.bat"
            with open(cli_shortcut, 'w', encoding='utf-8') as f:
                f.write(cli_script)
            
            print("‚úÖ Skr√≥ty utworzone na pulpicie")
            return True
        else:
            print("‚ö†Ô∏è Nie mo≈ºna znale≈∫ƒá pulpitu")
            return False
            
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd tworzenia skr√≥t√≥w: {e}")
        return False

def create_start_scripts():
    """Stw√≥rz skrypty startowe"""
    print("\nüìù Tworzenie skryt√≥w startowych...")
    
    try:
        # G≈Ç√≥wny skrypt startowy
        start_script = """@echo off
title Real-time Speech-to-Text Polish
echo.
echo üé§ Real-time Speech-to-Text Polish
echo ================================
echo.
echo Wybierz opcjƒô:
echo 1. GUI Application
echo 2. Command Line Demo
echo 3. Audio Test
echo 4. Complete System Test
echo 5. Install Whisper Dependencies
echo.
set /p choice="Wyb√≥r (1-5): "

if "%choice%"=="1" (
    python gui_launcher.py
) else if "%choice%"=="2" (
    python main.py --mode demo
) else if "%choice%"=="3" (
    python main.py --mode audio-test
) else if "%choice%"=="4" (
    python test_complete_system.py
) else if "%choice%"=="5" (
    python install_whisper_dependencies.py
) else (
    echo Nieprawid≈Çowy wyb√≥r
)

pause"""
        
        with open("start.bat", 'w', encoding='utf-8') as f:
            f.write(start_script)
        
        print("‚úÖ Skrypt start.bat utworzony")
        return True
        
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd tworzenia skrypt√≥w: {e}")
        return False

def show_installation_summary():
    """Poka≈º podsumowanie instalacji"""
    print("\n" + "=" * 60)
    print("üéâ INSTALACJA ZAKO≈ÉCZONA!")
    print("=" * 60)
    
    print("\nüöÄ Real-time Speech-to-Text Polish jest gotowy!")
    
    print("\nüìã Dostƒôpne opcje uruchomienia:")
    print("   üé® GUI:           python gui_launcher.py")
    print("   üé§ Demo CLI:      python main.py --mode demo")
    print("   üß™ Test audio:    python main.py --mode audio-test")
    print("   üìä Test systemu:  python test_complete_system.py")
    print("   ‚öôÔ∏è ≈Åatwy start:   start.bat")
    
    print("\nüí° Pierwsze uruchomienie:")
    print("   1. Uruchom test systemu: python test_complete_system.py")
    print("   2. Je≈õli wszystko OK, uruchom GUI: python gui_launcher.py")
    print("   3. Lub demo CLI: python main.py --mode demo")
    
    print("\nüéØ Funkcjonalno≈õci:")
    print("   ‚úÖ Real-time transkrypcja z mikrofonu")
    print("   ‚úÖ Zaawansowana detekcja aktywno≈õci g≈Çosowej")
    print("   ‚úÖ Optymalizacje dla jƒôzyka polskiego")
    print("   ‚úÖ Eksport do wielu format√≥w (TXT, JSON, SRT, etc.)")
    print("   ‚úÖ Monitoring wydajno≈õci systemu")
    print("   ‚úÖ Graficzny interfejs u≈ºytkownika")
    
    print("\nüìñ Dokumentacja:")
    print("   README.md - G≈Ç√≥wna dokumentacja (EN)")
    print("   docs/README_PL.md - Dokumentacja polska")
    print("   logs/ - Logi rozwoju projektu")
    
    print("\nüÜò Pomoc:")
    print("   - Je≈õli masz problemy, uruchom: python test_complete_system.py")
    print("   - Sprawd≈∫ logi w folderze logs/")
    print("   - GitHub: https://github.com/fortenemy/realtime-stt-polish")

def main():
    """G≈Ç√≥wna funkcja instalatora"""
    print_banner()
    
    # Sprawd≈∫ Python
    if not check_python_version():
        input("Press Enter to exit...")
        return False
    
    print("\nüöÄ Rozpoczynam instalacjƒô systemu...")
    print("‚è±Ô∏è To mo≈ºe potrwaƒá 5-15 minut (zale≈ºy od po≈ÇƒÖczenia)")
    
    # Pytaj o zgodƒô
    response = input("\nKontynuowaƒá pe≈ÇnƒÖ instalacjƒô? (y/N): ").lower()
    if response != 'y':
        print("‚ùå Instalacja anulowana")
        return False
    
    # Kroki instalacji
    steps = [
        ("Podstawowe biblioteki", install_basic_dependencies),
        ("PyTorch", install_pytorch),
        ("OpenAI Whisper", install_whisper),
        ("Opcjonalne pakiety", install_optional_packages),
        ("Test instalacji", test_installation),
        ("Model Whisper", download_whisper_model),
        ("Skr√≥ty pulpitu", create_desktop_shortcuts),
        ("Skrypty startowe", create_start_scripts)
    ]
    
    results = []
    for step_name, step_func in steps:
        print(f"\nüîÑ {step_name}...")
        try:
            result = step_func()
            results.append((step_name, result))
            
            if result:
                print(f"‚úÖ {step_name} - zako≈Ñczone pomy≈õlnie")
            else:
                print(f"‚ö†Ô∏è {step_name} - problemy (nie krytyczne)")
                
        except Exception as e:
            print(f"üí• {step_name} - b≈ÇƒÖd: {e}")
            results.append((step_name, False))
    
    # Podsumowanie
    successful = sum(1 for _, success in results if success)
    total = len(results)
    
    print(f"\nüìä Instalacja: {successful}/{total} krok√≥w zako≈Ñczonych sukcesem")
    
    if successful >= total - 2:  # Allow 2 failures
        show_installation_summary()
        return True
    else:
        print("\n‚ö†Ô∏è Instalacja czƒô≈õciowo nieudana")
        print("üîß Sprawd≈∫ b≈Çƒôdy powy≈ºej i spr√≥buj ponownie")
        
        print("\nüí° Mo≈ºesz te≈º zainstalowaƒá rƒôcznie:")
        print("   pip install -r requirements.txt")
        print("   python install_whisper_dependencies.py")
        
        return False

if __name__ == "__main__":
    try:
        success = main()
        input(f"\nPress Enter to exit...")
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\nüëã Instalacja przerwana przez u≈ºytkownika")
        sys.exit(0)
